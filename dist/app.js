"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const express_1=__importDefault(require("express")),body_parser_1=__importDefault(require("body-parser")),http_1=__importDefault(require("http")),lodash_1=__importDefault(require("lodash")),zeromq_1=require("zeromq"),moment_1=__importDefault(require("moment")),fs_1=__importDefault(require("fs")),request_1=__importDefault(require("request"));class App{constructor(t){this.config={entities:{endpoints:[],projects:[]},result:{httpPort:3e3,httpsPort:3001}},this.endpointsParams=new Map,this.endpointsBody=new Map,this.endpointsResponse=new Map,this.isListening=(()=>!!this.httpServer&&this.httpServer.listening),this.stop=(t=>{const e=e=>{if(!e){const t={type:0,message:"STOP",date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),matched:!0};this.socketLogs.send(JSON.stringify(t))}t(e)};this.httpServer&&this.httpServer.close(e),this.sslServer&&this.sslServer.close(e)}),this.start=(t=>{if(this.httpServer=http_1.default.createServer(this.express),this.httpServer.listen(this.port,e=>{if(!e){const t={type:0,message:"START",date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),matched:!0};this.socketLogs.send(JSON.stringify(t))}t(e)}).on("error",t=>{this.errorHandler.checkErrorAndStopProcess(t)}),fs_1.default.existsSync("./localhost.key")&&fs_1.default.existsSync("./localhost.crt")){fs_1.default.readFileSync("./localhost.key"),fs_1.default.readFileSync("./localhost.crt")}}),this.handleUIMessage=(t=>{switch(Number(t.toString())){case 0:return this.stop(this.handleError);case 1:return this.start(this.handleError)}}),this.handleError=(t=>{if(!t)return;const e={type:0,message:`ERROR ${t}`,matched:!0,date:moment_1.default().format("YYYY/MM/DD HH:mm:ss")};this.socketLogs.send(JSON.stringify(e))}),this.setupServer(this.config);const e="/tmp/apimocker_server";fs_1.default.existsSync(e)||fs_1.default.mkdirSync(e),this.errorHandler=t,this.socket=zeromq_1.socket("pull"),this.socket.connect(`ipc://${e}/commands.ipc`),this.socket.on("message",this.handleUIMessage),this.socketLogs=zeromq_1.socket("push"),this.socketLogs.bindSync(`ipc://${e}/logs.ipc`)}setupServer(t){this.config=t;const{httpPort:e,httpsPort:s}=t.result;this.port=e||3e3,this.sslPort=s||3001,this.express=express_1.default(),this.express.use(body_parser_1.default.raw({type:"*/*"})),this.mountRoutes()}mountRoutes(){const{endpoints:t,projects:e}=this.config.entities;lodash_1.default.forEach(t,t=>{const s=e[t.projectId],o="/"+s.name+t.path;this.register(t,s.name),t.request.params?this.endpointsResponse.set(t.method+o+t.request.params,t.response):t.request.body&&!lodash_1.default.isEqual(t.request.body,{})?this.endpointsResponse.set(t.method+o+JSON.stringify(t.request.body),t.response):this.endpointsResponse.set(t.method+o,t.response),this.parseParamsEndpoint(t,o),this.parseBodyEndpoint(t,o)}),this.express.use("/",(t,e,s)=>{this.handleMissedRoute(t,e)})}parseParamsEndpoint(t,e){const s=this.endpointsParams.get(e),o=s&&s.length>0?s:[];o.push(t.request.params),this.endpointsParams.set(e,o)}parseBodyEndpoint(t,e){const s=this.endpointsBody.get(e);if(s&&s.length>0){const o=s;o.push(t.request.body),this.endpointsBody.set(e,o)}else{const s=[];s.push(t.request.body),this.endpointsBody.set(e,s)}}getAppropriateListenerFunction(t){if("delete"===t)return this.express.delete.bind(this.express);if("get"===t)return this.express.get.bind(this.express);if("patch"===t)return this.express.patch.bind(this.express);if("post"===t)return this.express.post.bind(this.express);if("put"===t)return this.express.put.bind(this.express);throw new Error("[getAppropriateListenerFunction] Unexpected API method to listen for")}sendLog(t,e,s,o,r){const i={method:t.method,path:t.path,body:t.body,matched:e,protocol:t.protocol,host:t.hostname,date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),port:parseInt(this.port.toString(),10),query:t.query,type:s,statusCode:o,response:r};this.socketLogs.send(JSON.stringify(i))}register(t,e=""){const s="/"+e+t.path,o=t.method.toLowerCase(),r=t.statusCode||200,i=t.timeout||0;this.getAppropriateListenerFunction(o)(s,(t,e)=>{const s=e.status(r);if(t.query&&!lodash_1.default.isEmpty(t.query)){this.paramsExists(this.endpointsParams.get(t.path),t)?this.sendResponse(i,s,this.endpointsResponse.get(t.method+t.path+this.parseQueryToString(t.query)),t,r):this.sendResponse(i,s,"Not found",t,404)}else if(t.body&&!lodash_1.default.isEmpty(t.body)){const e=t.body.toString("utf8");this.bodyExists(this.endpointsBody.get(t.path),e)?this.isJsonString(e)?this.sendResponse(i,s,this.endpointsResponse.get(t.method+t.path+JSON.stringify(JSON.parse(e))),t,r):this.sendResponse(i,s,this.endpointsResponse.get(t.method+t.path+e),t,r):this.sendResponse(i,s,"Not found",t,404)}else this.sendResponse(i,s,this.endpointsResponse.get(t.method+t.path),t,r)})}isJsonString(t){try{JSON.parse(t)}catch(t){return!1}return!0}bodyExists(t,e){let s=!1;return t.forEach(t=>{this.isJsonString(e)?lodash_1.default.isEqual(e,{})&&lodash_1.default.isEqual(t,e)?s=!0:lodash_1.default.isEqual(t,JSON.parse(e))&&(s=!0):lodash_1.default.isEqual(t,e)&&(s=!0)}),s}paramsExists(t,e){let s=!1;return t.forEach(t=>{lodash_1.default.isEqual(this.parseQuery(t),e.query)&&(s=!0)}),s}sendResponse(t,e,s,o,r){t>0?setTimeout(()=>e.status(r).send(s),t):e.status(r).send(s),this.sendLog(o,!0,1,r)}parseQuery(t){if(t.length>0){const e={},s=("?"===t[0]?t.substr(1):t).split("&");for(const t of s){const s=t.split("=");e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||"")}return e}return{}}parseQueryToString(t){return"?"+Object.keys(t).reduce((e,s)=>(e.push(s+"="+encodeURIComponent(t[s])),e),[]).join("&")}handleMissedRoute(t,e){const s=t.originalUrl.split("/")[1],o=lodash_1.default.find(this.config.entities.projects,t=>t.name===s);o&&o.fallbackUrlPrefix&&o.fallbackUrlPrefix.domain?this.forwardRequest(t,e):(this.sendLog(t,!1,2,404),e.status(404).send("Not found"))}getForwardingOptions(t){const[e,s,...o]=t.originalUrl.split("/"),r=lodash_1.default.find(this.config.entities.projects,t=>t.name===s),{domain:i,path:n,port:a}=r.fallbackUrlPrefix,h=`http://${i}${a?`:${a}`:""}${n}/${o.join("/")}`;return{headers:Object.assign({},t.headers,{host:i}),method:t.method,body:"GET"===t.method?null:t.body,url:h}}forwardRequest(t,e){const s=this.getForwardingOptions(t);request_1.default(s,(e,s,o)=>{e?this.sendLog(t,!1,3,0,e.toString()):this.sendLog(t,!0,2,s&&s.statusCode?s.statusCode:418,o.toString())}).pipe(e)}}exports.default=App;