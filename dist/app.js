"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const express_1=__importDefault(require("express")),body_parser_1=__importDefault(require("body-parser")),http_1=__importDefault(require("http")),lodash_1=__importDefault(require("lodash")),zeromq_1=require("zeromq"),moment_1=__importDefault(require("moment")),fs_1=__importDefault(require("fs")),request_1=__importDefault(require("request"));class App{constructor(e){this.config={entities:{endpoints:[],projects:[]},result:{httpPort:3e3,httpsPort:3001}},this.endpointsParams=new Map,this.endpointsResponse=new Map,this.isListening=(()=>!!this.httpServer&&this.httpServer.listening),this.stop=(e=>{const t=t=>{if(!t){const e={type:0,message:"STOP",date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),matched:!0};this.socketLogs.send(JSON.stringify(e))}e(t)};this.httpServer&&this.httpServer.close(t),this.sslServer&&this.sslServer.close(t)}),this.start=(e=>{if(this.httpServer=http_1.default.createServer(this.express),this.httpServer.listen(this.port,t=>{if(!t){const e={type:0,message:"START",date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),matched:!0};this.socketLogs.send(JSON.stringify(e))}e(t)}).on("error",e=>{this.errorHandler.checkErrorAndStopProcess(e)}),fs_1.default.existsSync("./localhost.key")&&fs_1.default.existsSync("./localhost.crt")){fs_1.default.readFileSync("./localhost.key"),fs_1.default.readFileSync("./localhost.crt")}}),this.handleUIMessage=(e=>{switch(Number(e.toString())){case 0:return this.stop(this.handleError);case 1:return this.start(this.handleError)}}),this.handleError=(e=>{if(!e)return;const t={type:0,message:`ERROR ${e}`,matched:!0,date:moment_1.default().format("YYYY/MM/DD HH:mm:ss")};this.socketLogs.send(JSON.stringify(t))}),this.setupServer(this.config);const t="/tmp/apimocker_server";fs_1.default.existsSync(t)||fs_1.default.mkdirSync(t),this.errorHandler=e,this.socket=zeromq_1.socket("pull"),this.socket.connect(`ipc://${t}/commands.ipc`),this.socket.on("message",this.handleUIMessage),this.socketLogs=zeromq_1.socket("push"),this.socketLogs.bindSync(`ipc://${t}/logs.ipc`)}setupServer(e){this.config=e;const{httpPort:t,httpsPort:s}=e.result;this.port=t||3e3,this.sslPort=s||3001,this.express=express_1.default(),this.express.use(body_parser_1.default.raw({type:"*/*"})),this.mountRoutes()}mountRoutes(){const{endpoints:e,projects:t}=this.config.entities;lodash_1.default.forEach(e,e=>{const s=t[e.projectId];this.register(e,s.name);const r="/"+s.name+e.path,o=this.endpointsParams.get(r);if(this.endpointsResponse.set(e.method+r+e.request.params,e.response),o&&o.length>0){const t=o;t.push(e.request.params),this.endpointsParams.set(r,t)}else{const t=[];t.push(e.request.params),this.endpointsParams.set(r,t)}}),this.addMissedRouteHandler()}getAppropriateListenerFunction(e){if("delete"===e)return this.express.delete.bind(this.express);if("get"===e)return this.express.get.bind(this.express);if("patch"===e)return this.express.patch.bind(this.express);if("post"===e)return this.express.post.bind(this.express);if("put"===e)return this.express.put.bind(this.express);throw new Error("[getAppropriateListenerFunction] Unexpected API method to listen for")}sendLog(e,t,s,r,o){const i={method:e.method,path:e.path,body:e.body,matched:t,protocol:e.protocol,host:e.hostname,date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),port:parseInt(this.port.toString(),10),query:e.query,type:s,statusCode:r,response:o};this.socketLogs.send(JSON.stringify(i))}register(e,t=""){e.request.params;const s="/"+t+e.path,r=e.method.toLowerCase(),o=e.statusCode||200,i=e.timeout||0;this.getAppropriateListenerFunction(r)(s,(e,t)=>{const s=t.status(o);if(e.query&&!lodash_1.default.isEmpty(e.query)){const t=this.endpointsParams.get(e.path);let r=!1;t.forEach(t=>{lodash_1.default.isEqual(this.parseQuery(t),e.query)&&(r=!0)}),r?(this.sendResponse(i,s,this.endpointsResponse.get(e.method+e.path+this.parseQueryToString(e.query))),this.sendLog(e,!0,1,o)):(this.sendResponse(i,s,"Not found"),this.sendLog(e,!0,1,404))}else this.sendResponse(i,s,this.endpointsResponse.get(e.method+e.path)),this.sendLog(e,!0,1,o)})}sendResponse(e,t,s){e>0?setTimeout(()=>t.send(s),e):t.send(s)}parseQuery(e){if(e.length>0){const t={},s=("?"===e[0]?e.substr(1):e).split("&");for(const e of s){const s=e.split("=");t[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||"")}return t}return{}}parseQueryToString(e){return"?"+Object.keys(e).reduce((t,s)=>(t.push(s+"="+encodeURIComponent(e[s])),t),[]).join("&")}addMissedRouteHandler(){this.express.use("/",(e,t,s)=>{const r=e.originalUrl.split("/")[1],o=lodash_1.default.find(this.config.entities.projects,e=>e.name===r);if(o&&o.fallbackUrlPrefix&&o.fallbackUrlPrefix.domain){this.forwardRequest(e,t)}else this.sendLog(e,!1,2,404),t.status(404).send("Not found")})}getForwardingOptions(e){const[t,s,...r]=e.originalUrl.split("/"),o=lodash_1.default.find(this.config.entities.projects,e=>e.name===s),{domain:i,path:n,port:a}=o.fallbackUrlPrefix,h=`http://${i}${a?`:${a}`:""}${n}/${r.join("/")}`;return{headers:Object.assign({},e.headers,{host:i}),method:e.method,body:"GET"===e.method?null:e.body,url:h}}forwardRequest(e,t){const s=this.getForwardingOptions(e);request_1.default(s,(t,s,r)=>{t?this.sendLog(e,!1,3,0,t.toString()):this.sendLog(e,!0,2,s&&s.statusCode?s.statusCode:418,r)}).pipe(t)}}exports.default=App;