"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))(function(s,a){function o(e){try{h(i.next(e))}catch(e){a(e)}}function n(e){try{h(i.throw(e))}catch(e){a(e)}}function h(e){e.done?s(e.value):new t(function(r){r(e.value)}).then(o,n)}h((i=i.apply(e,r||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=__importDefault(require("fs")),normalizr_1=require("normalizr"),util_1=require("util"),app_1=__importDefault(require("./app")),DataSchema_1=require("./Models/DataSchema"),error_handler_1=__importDefault(require("./errors/error-handler"));class Server{constructor(e,r){this.readFileAsync=util_1.promisify(fs_1.default.readFile),this.run=(()=>{console.log("Starting run"),this.watchConfigForChanges(this.configFilePath),this.readAndStart()}),this.watchConfigForChanges=(e=>{fs_1.default.watchFile(e,()=>{console.log("-----------------------------------------"),console.log(e+" changed"),this.readAndStart()})}),this.parseConfig=(e=>{return normalizr_1.normalize(e,DataSchema_1.ConfigSchema)}),this.readAndStart=(()=>{this.readFile(this.configFilePath).then(e=>{const r=this.parseConfig(e);this.restartServer(r)}).catch(e=>{this.errorHandler.checkErrorAndStopProcess(e),this.stopServer()})}),this.stopServer=(e=>{this.app&&this.app.stop(r=>{r?console.error(r):e&&e()})}),this.restartServer=(e=>{this.app.isListening()?this.stopServer(()=>this._startServer(e)):this._startServer(e)}),this._startServer=(e=>{this.app.setupServer(e),this.app.start(e=>e?console.error(e):console.log("server is listening"))}),this.errorHandler=new error_handler_1.default(r),this.app=new app_1.default(this.errorHandler),this.configFilePath=e||"./apimocker.json",console.log("Reading config file from: "+this.configFilePath)}readFile(e){return __awaiter(this,void 0,void 0,function*(){const r=yield this.readFileAsync(e,{encoding:"utf-8"});return JSON.parse(r)})}}exports.default=Server;